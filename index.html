<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Raw Data → CSV</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        background: #f5f7fb;
        padding: 40px;
      }
      .card {
        max-width: 600px;
        margin: auto;
        background: #fff;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      }
      h1 {
        font-size: 1.4rem;
        margin-bottom: 10px;
      }
      input,
      button {
        width: 100%;
        margin-top: 12px;
        padding: 10px;
        font-size: 1rem;
      }
      button {
        background: #2563eb;
        color: #fff;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }
      textarea {
        width: 100%;
      }
      button:hover {
        background: #1e4ed8;
      }
      small,
      span {
        color: #555;
      }
      #dropZone {
        border: 3px dashed #2563eb;
        border-radius: 12px;
        padding: 40px;
        text-align: center;
        font-size: 1rem;
        color: #2563eb;
        margin-bottom: 16px;
        transition: background-color 0.3s ease;
        cursor: pointer;
      }
      #dropZone.dragover {
        background-color: #dbeafe;
      }
      .card {
        display: none;
      }
      #authBar {
        max-width: 400px;
        margin: 0 auto 30px auto;
        padding: 24px 60px 30px 24px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(37, 99, 235, 0.15);
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      #userStatus {
        font-weight: 600;
        font-size: 1.1rem;
        color: #2563eb;
        margin-bottom: 16px;
        text-align: center;
      }

      #loginForm {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      #loginForm input {
        padding: 12px 0px 12px 10px;
        font-size: 1rem;
        border: 2px solid #cbd5e1; /* slate-300 */
        border-radius: 8px;
        transition: border-color 0.3s ease;
      }

      #loginForm input:focus {
        outline: none;
        border-color: #2563eb; /* blue-600 */
        box-shadow: 0 0 5px rgba(37, 99, 235, 0.5);
      }

      #loginForm button {
        width: 100%;
        padding: 12px;
        font-size: 1rem;
        font-weight: 700;
        background-color: #2563eb; /* blue-600 */
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        margin: 9px;
      }

      #loginForm button:hover {
        background-color: #1e40af; /* blue-800 */
      }

      #logoutBtn {
        display: block;
        margin: 30px auto;
        width: 30%;
        padding: 10px 30px;
        font-size: 1rem;
        font-weight: 700;
        background-color: #4671ce; /* red-500 */
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        display: none;
        transition: background-color 0.3s ease;
      }

      #logoutBtn:hover {
        background-color: #b91c1c; /* red-700 */
      }
    </style>
  </head>
  <body>
    <div id="authBar">
      <div id="userStatus">Not signed in</div>
      <div id="loginForm">
        <input type="text" id="username" placeholder="Username" />
        <input type="password" id="password" placeholder="Password" />
        <button onclick="login()">Sign In</button>
      </div>
      
    </div>

    <div class="card">
      <div style="text-align: center">
        Brought You by
        <span style="font-weight: bold; color: #1e4ed8"
          >"Biman Pricing Team"</span
        >
      </div>
      <h1>PNR RAW → CSV Converter</h1>
      
      <small>Upload .txt/docs or paste raw PNR data or drag and drop.</small>

      <input type="file" id="fileInput" accept=".txt,.doc,.docx" />

      <textarea
        id="textInput"
        cols="30"
        rows="10"
        placeholder="Or paste raw PNR text here..."
      ></textarea>

      <div id="dropZone">Drag & Drop your .txt or .docx file here</div>
      <!-- <input type="file" id="fileInput" accept=".txt,.docx" /> -->

      <button onclick="processData()">Generate CSV</button>

      <button style="display: block;" id="logoutBtn" style="display: none" onclick="logout()">
        Sign Out
      </button>
    </div>
    <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>

    <script>
      const correctUsername = "pricing_section";
      const correctPassword = "01977772188";

      function login() {
        const userInput = document.getElementById("username").value.trim();
        const passInput = document.getElementById("password").value.trim();

        if (userInput === correctUsername && passInput === correctPassword) {
          localStorage.setItem("loggedIn", "true");
          updateUser(true);
        } else {
          alert("Incorrect username or password");
        }
      }

      function logout() {
        localStorage.removeItem("loggedIn");
        updateUser(false);
      }

      function updateUser(isLoggedIn) {
        const status = document.getElementById("userStatus");
        const loginForm = document.getElementById("loginForm");
        const logoutBtn = document.getElementById("logoutBtn");
        const card = document.querySelector(".card");

        if (isLoggedIn) {
          status.textContent = `Signed in as: ${correctUsername}`;
          loginForm.style.display = "none";
          logoutBtn.style.display = "inline-block";
          card.style.display = "block";
        } else {
          status.textContent = "Not signed in";
          loginForm.style.display = "block";
          logoutBtn.style.display = "none";
          card.style.display = "none";
        }
      }

      // On page load check login status
      document.addEventListener("DOMContentLoaded", () => {
        const loggedIn = localStorage.getItem("loggedIn") === "true";
        updateUser(loggedIn);
      });

      const dropZone = document.getElementById("dropZone");

      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("dragover");
      });

      dropZone.addEventListener("dragleave", (e) => {
        dropZone.classList.remove("dragover");
      });

      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.classList.remove("dragover");

        const files = e.dataTransfer.files;
        if (files.length === 0) return;

        // Set dropped file to input for consistency
        const fileInput = document.getElementById("fileInput");
        fileInput.files = files;

        // Automatically process dropped file
        processData();
      });
      function processData() {
        const fileInput = document.getElementById("fileInput");
        const textArea = document.getElementById("textInput");
        const file = fileInput.files[0];

        if (file) {
          const ext = file.name.split(".").pop().toLowerCase();

          if (ext === "txt") {
            const reader = new FileReader();
            reader.onload = (e) => parsePNR(e.target.result);
            reader.onerror = () => alert("TXT file read failed");
            reader.readAsText(file);
          } else if (ext === "docx") {
            const reader = new FileReader();
            reader.onload = async (e) => {
              try {
                const arrayBuffer = e.target.result;
                const result = await mammoth.extractRawText({ arrayBuffer });
                parsePNR(result.value);
              } catch (err) {
                alert("DOCX parsing failed");
              }
            };
            reader.readAsArrayBuffer(file);
          } else {
            alert("Only TXT and DOCX files are supported");
          }
        } else if (textArea.value.trim()) {
          parsePNR(textArea.value);
        } else {
          alert("Please upload a file or paste text");
        }
      }

      function parsePNR(raw) {
        let lines = raw
          .replace(/\r/g, "")
          .replace(/MD«/g, "")
          .split("\n")
          .map((l) => l.trim())
          .filter(Boolean);

        const results = [];
        let currentPNR = "";
        let RBD = "";

        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];

          const RBD_find = line.match(/^\d+\s[^.]+\.{2}\d\.([A-Z])/);
          if (RBD_find) RBD = RBD_find[1];

          const pnrMatch = line.match(/\.{6,}\s*([A-Z0-9]{6})/i);
          if (pnrMatch) {
            currentPNR = pnrMatch[1];
            continue;
          }

          if (/SSR DOCS/i.test(line)) {
            let nextLine =
              i + 1 < lines.length && /^[0-9]/.test(lines[i + 1])
                ? lines[i + 1]
                : "";
            const combined = line + " " + nextLine;

            const nameMatch = combined.match(
              /\d\.\d\s+([A-Z\/\s]+?)(MR|MRS|MS|MISS|MSTR)/i
            );
            let name = nameMatch ? nameMatch[1].trim() : "";
            if (!name) {
              const fallbackName = combined.match(/\d\.\d\s+([A-Z\/\s]+)/i);
              name = fallbackName ? fallbackName[1].trim() : "";
            }
            name = name.replace(/(MR|MRS|MS|MISS|MSTR)$/i, "").trim();

            let passport = "",
              country = "";
            const passSSR = line.match(/\/P\/([A-Z]{2,3})\/([A-Z0-9]+)/i);
            const passNext = nextLine.match(/^([0-9]+)/);

            if (passSSR && passNext) {
              country = passSSR[1];
              passport = passSSR[2] + passNext[1];
            } else {
              const fallback = combined.match(
                /([A-Z]{1,3}[0-9]{4,6})\/(BD|BGD)/i
              );
              if (fallback) {
                passport = fallback[1];
                country = fallback[2];
              }
            }

            if (name || passport) {
              results.push({
                Name: name,
                PNR: currentPNR,
                Passport: passport,
                Country: country,
                RBD: RBD || "",
                Need_check:
                  passport && passport.length !== 9 ? "YES" : "May be",
              });
            }
          }
        }

        downloadCSV(results);
        showErrors(results);
        resetInputs();
      }

      function resetInputs() {
        document.getElementById("fileInput").value = "";
        document.getElementById("textInput").value = "";
      }

      function showErrors(rows) {
        const old = document.getElementById("errorTable");
        if (old) old.remove();

        const errors = rows.filter((r) => r.Need_check === "YES");
        if (!errors.length) return;

        const table = document.createElement("table");
        table.id = "errorTable";
        table.style.width = "100%";
        table.style.marginTop = "20px";
        table.border = "1";

        table.innerHTML = `
          <thead>
            <tr>
              <th>Name</th><th>PNR</th><th>Passport</th><th>Country</th><th>RBD</th>
            </tr>
          </thead>
          <tbody>
            ${errors
              .map(
                (e) => `
              <tr>
                <td>${e.Name}</td>
                <td>${e.PNR}</td>
                <td>${e.Passport}</td>
                <td>${e.Country}</td>
                <td>${e.RBD}</td>
              </tr>`
              )
              .join("")}
          </tbody>
        `;

        document.querySelector(".card").appendChild(table);
        const header = "Name,PNR,Passport,Country,RBD,Need_check\n";
        const csv = errors
          .map(
            (r) =>
              `"${r.Name}","${r.PNR}","${r.Passport}","${r.Country}","${r.RBD}","${r.Need_check}"`
          )
          .join("\n");
        const blob = new Blob([header + csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "error_pnrs.csv";
        a.click();
        URL.revokeObjectURL(url);
      }

      function downloadCSV(rows) {
        const header = "Name,PNR,Passport,Country,RBD,Need_check\n";
        const csv = rows
          .map(
            (r) =>
              `"${r.Name}","${r.PNR}","${r.Passport}","${r.Country}","${r.RBD}","${r.Need_check}"`
          )
          .join("\n");
        const blob = new Blob([header + csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "pricing_hub.csv";
        a.click();
        URL.revokeObjectURL(url);
      }
    </script>
  </body>
</html>
