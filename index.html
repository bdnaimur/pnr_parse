<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PNR TXT → CSV Parser</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f7fb;
      padding: 40px;
    }
    .card {
      max-width: 600px;
      margin: auto;
      background: #fff;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    }
    h1 { font-size: 1.4rem; margin-bottom: 10px; }
    input, button {
      width: 100%;
      margin-top: 12px;
      padding: 10px;
      font-size: 1rem;
    }
    button {
      background: #2563eb;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    textarea{
      width: 100%;
    }
    button:hover { background: #1e4ed8; }
    small, span { color: #555; }


  </style>
</head>
<body>
  <div class="card">
    <span>Powered By Biman Pricing Team</span>
    <h1>PNR RAW → CSV Converter</h1>
    <small>Upload .txt or paste raw PNR data.</small>

    <input type="file" id="fileInput" accept=".txt,.doc,.docx" />

    <textarea id="textInput" cols="30" rows="10" placeholder="Or paste raw PNR text here..."></textarea>

    <button onclick="processData()">Generate CSV</button>


  </div>

<script>
function processData() {
  const file = document.getElementById('fileInput').files[0];
  const textArea = document.getElementById('textInput');

  if (file) {
    const reader = new FileReader();
    reader.onload = e => parsePNR(e.target.result);
    reader.readAsText(file);
  } else if (textArea.value.trim()) {
    parsePNR(textArea.value);
  } else {
    alert('Please upload a file or paste text');
  }
}

function parsePNR(raw) {

  span.remove()

  let lines = raw
    .replace(/\r/g, '')
    .replace(/MD«/g, '')
    .split('\n')
    .map(l => l.trim())
    .filter(Boolean);

  const results = [];
  let currentPNR = '';
  let RBD = '';

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];

    const RBD_find = line.match(/^\d+\s[^.]+\.{2}\d\.([A-Z])/);
    if (RBD_find) RBD = RBD_find[1];

    const pnrMatch = line.match(/\.{6,}\s*([A-Z0-9]{6})/i);
    if (pnrMatch) {
      currentPNR = pnrMatch[1];
      continue;
    }

    if (/SSR DOCS/i.test(line)) {
      let nextLine = i + 1 < lines.length && /^[0-9]/.test(lines[i + 1]) ? lines[i + 1] : '';
      const combined = line + ' ' + nextLine;

      const nameMatch = combined.match(/\d\.\d\s+([A-Z\/\s]+?)(MR|MRS|MS|MISS|MSTR)/i);
      let name = nameMatch ? nameMatch[1].trim() : '';
      if (!name) {
        const fallbackName = combined.match(/\d\.\d\s+([A-Z\/\s]+)/i);
        name = fallbackName ? fallbackName[1].trim() : '';
      }
      name = name.replace(/(MR|MRS|MS|MISS|MSTR)$/i, '').trim();

      let passport = '', country = '';
      const passSSR = line.match(/\/P\/([A-Z]{2,3})\/([A-Z0-9]+)/i);
      const passNext = nextLine.match(/^([0-9]+)/);

      if (passSSR && passNext) {
        country = passSSR[1];
        passport = passSSR[2] + passNext[1];
      } else {
        const fallback = combined.match(/([A-Z]{1,3}[0-9]{4,6})\/(BD|BGD)/i);
        if (fallback) {
          passport = fallback[1];
          country = fallback[2];
        }
      }

      if (name || passport) {
        results.push({
          Name: name,
          PNR: currentPNR,
          Passport: passport,
          Country: country,
          RBD: RBD || '',
          Need_check: passport && passport.length !== 9 ? 'YES' : 'May be'
        });
      }
    }
  }

  downloadCSV(results);
  showErrors(results);
  resetInputs();
}

function resetInputs() {
  document.getElementById('fileInput').value = '';
  document.getElementById('textInput').value = '';
}

const span = document.createElement("h3");

function showErrors(rows) {
  const old = document.getElementById('errorTable');
  if (old) old.remove();

  const errors = rows.filter(r => r.Need_check === 'YES');
  if (!errors.length) {
    span.id = "noErrorMessege";
    span.style.marginTop = '20px';
    span.style.textAlign= "center";
    span.style.color = 'red';
    span.innerHTML = `No Error Found`;
    console.log("inside error", span);
     document.querySelector('.card').appendChild(span);
    return;
  };

  const table = document.createElement('table');
  table.id = 'errorTable';
  table.style.width = '100%';
  table.style.marginTop = '20px';
  table.border = '1';

  table.innerHTML = `
    <thead>
      <tr>
        <th>Name</th><th>PNR</th><th>Passport</th><th>Country</th><th>RBD</th>
      </tr>
    </thead>
    <tbody>
      ${errors.map(e => `
        <tr>
          <td>${e.Name}</td>
          <td>${e.PNR}</td>
          <td>${e.Passport}</td>
          <td>${e.Country}</td>
          <td>${e.RBD}</td>
        </tr>`).join('')}
    </tbody>
  `;

  document.querySelector('.card').appendChild(table);
}

function downloadCSV(rows) {
  const header = 'Name,PNR,Passport,Country,RBD,Need_check\n';
  const csv = rows.map(r =>
    `"${r.Name}","${r.PNR}","${r.Passport}","${r.Country}","${r.RBD}","${r.Need_check}"`
  ).join('\n');

  const blob = new Blob([header + csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = 'pnr_output.csv';
  a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
