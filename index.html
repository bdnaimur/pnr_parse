<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Raw Data → CSV</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/style/style.css" />
  </head>
  <body>
    <div id="authBar">
      <div id="userStatus">Not signed in</div>
      <!-- <div id="loginForm">
        <input type="text" id="username" placeholder="Username" />
        <input type="password" id="password" placeholder="Password" />
        <button onclick="login()">Sign In</button>
      </div> -->
      <form id="loginForm">
        <input id="username" type="text" placeholder="Username" />
        <input id="password" type="password" placeholder="Password" />
        <button type="submit">Login</button>
      </form>
    </div>

    <div class="card">
      <div style="text-align: center">
        Brought You by
        <span style="font-weight: bold; color: #1e4ed8"
          >"Biman Pricing Team"</span
        >
      </div>
      <h1>PNR RAW → CSV Converter</h1>

      <small>Upload .txt/docs or paste raw PNR data or drag and drop.</small>

      <input type="file" id="fileInput" accept=".txt,.doc,.docx" />

      <textarea
        id="textInput"
        cols="30"
        rows="10"
        placeholder="Or paste raw PNR text here..."
      ></textarea>

      <div id="dropZone">Drag & Drop your .txt or .docx file here</div>
      <!-- <input type="file" id="fileInput" accept=".txt,.docx" /> -->

      <button onclick="processData()">Generate CSV</button>

      <button
        style="display: block"
        id="logoutBtn"
        style="display: none"
        onclick="logout()"
      >
        Sign Out
      </button>
    </div>
    <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>

    <script src="/app/js/auth.js"></script>
    <script src="/app/js/inactivity.js"></script>
    <script src="/app/js/dragDrop.js"></script>
    <script src="/app/js/fileHandler.js"></script>
    <script src="/app/js/parser.js"></script>
    <script src="/app/js/csv.js"></script>
    <script src="/app/js/main.js"></script>
    <!-- 
    <script>
      const correctUsername = "pricing_section";
      const correctPassword = "01977772188";
      const AUTO_LOGOUT_TIME = 5 * 60 * 1000; // 5 minutes
      let inactivityTimer = null;

      function startInactivityTimer() {
        clearTimeout(inactivityTimer);

        inactivityTimer = setTimeout(() => {
          alert("You have been logged out due to inactivity.");
          logout();
        }, AUTO_LOGOUT_TIME);
      }

      function resetInactivityTimer() {
        if (localStorage.getItem("loggedIn") === "true") {
          startInactivityTimer();
        }
      }

      ["click", "mousemove", "keydown", "scroll", "touchstart"].forEach(
        (event) => {
          document.addEventListener(event, resetInactivityTimer, true);
        }
      );

      document.addEventListener("DOMContentLoaded", () => {
        const loggedIn = localStorage.getItem("loggedIn") === "true";
        updateUser(loggedIn);

        if (loggedIn) {
          startInactivityTimer();
        }
      });

      // function login() {
      //   const userInput = document.getElementById("username").value.trim();
      //   const passInput = document.getElementById("password").value.trim();

      //   if (userInput === correctUsername && passInput === correctPassword) {
      //     localStorage.setItem("loggedIn", "true");
      //     updateUser(true);
      //   } else {
      //     alert("Incorrect username or password");
      //   }
      // }

      function login() {
        const userInput = document.getElementById("username").value.trim();
        const passInput = document.getElementById("password").value.trim();

        if (userInput === correctUsername && passInput === correctPassword) {
          localStorage.setItem("loggedIn", "true");
          updateUser(true);
          startInactivityTimer();
        } else {
          alert("Incorrect username or password");
        }
      }

      // function logout() {
      //   localStorage.removeItem("loggedIn");
      //   updateUser(false);
      // }

      function logout() {
        localStorage.removeItem("loggedIn");
        clearTimeout(inactivityTimer);
        updateUser(false);
      }

      function updateUser(isLoggedIn) {
        const status = document.getElementById("userStatus");
        const loginForm = document.getElementById("loginForm");
        const logoutBtn = document.getElementById("logoutBtn");
        const card = document.querySelector(".card");

        if (isLoggedIn) {
          status.textContent = `Signed in as: ${correctUsername}`;
          loginForm.style.display = "none";
          logoutBtn.style.display = "inline-block";
          card.style.display = "block";
        } else {
          status.textContent = "Not signed in";
          loginForm.style.display = "block";
          logoutBtn.style.display = "none";
          card.style.display = "none";
        }
      }

      // On page load check login status
      document.addEventListener("DOMContentLoaded", () => {
        const loggedIn = localStorage.getItem("loggedIn") === "true";
        updateUser(loggedIn);
      });

      const dropZone = document.getElementById("dropZone");

      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("dragover");
      });

      dropZone.addEventListener("dragleave", (e) => {
        dropZone.classList.remove("dragover");
      });

      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.classList.remove("dragover");

        const files = e.dataTransfer.files;
        if (files.length === 0) return;

        // Set dropped file to input for consistency
        const fileInput = document.getElementById("fileInput");
        fileInput.files = files;

        // Automatically process dropped file
        processData();
      });
      function processData() {
        const fileInput = document.getElementById("fileInput");
        const textArea = document.getElementById("textInput");
        const file = fileInput.files[0];

        if (file) {
          const ext = file.name.split(".").pop().toLowerCase();

          if (ext === "txt") {
            const reader = new FileReader();
            reader.onload = (e) => parsePNR(e.target.result);
            reader.onerror = () => alert("TXT file read failed");
            reader.readAsText(file);
          } else if (ext === "docx") {
            const reader = new FileReader();
            reader.onload = async (e) => {
              try {
                const arrayBuffer = e.target.result;
                const result = await mammoth.extractRawText({ arrayBuffer });
                parsePNR(result.value);
              } catch (err) {
                alert("DOCX parsing failed");
              }
            };
            reader.readAsArrayBuffer(file);
          } else {
            alert("Only TXT and DOCX files are supported");
          }
        } else if (textArea.value.trim()) {
          parsePNR(textArea.value);
        } else {
          alert("Please upload a file or paste text");
        }
      }

      function parsePNR(raw) {
        let lines = raw
          .replace(/\r/g, "")
          .replace(/MD«/g, "")
          .split("\n")
          .map((l) => l.trim())
          .filter(Boolean);

        const results = [];
        let currentPNR = "";
        let RBD = "";

        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];

          const RBD_find = line.match(/^\d+\s[^.]+\.{2}\d\.([A-Z])/);
          if (RBD_find) RBD = RBD_find[1];

          const pnrMatch = line.match(/\.{6,}\s*([A-Z0-9]{6})/i);
          if (pnrMatch) {
            currentPNR = pnrMatch[1];
            continue;
          }

          if (/SSR DOCS/i.test(line)) {
            let nextLine =
              i + 1 < lines.length && /^[0-9]/.test(lines[i + 1])
                ? lines[i + 1]
                : "";
            const combined = line + " " + nextLine;

            // Extract Name (handle cases like "SHAHABULMR" with no space before MR)
            const nameMatch = combined.match(
              /\d\.\d\s+([A-Z\/\s]+?)(?:\s*|\b)(MR|MRS|MS|MISS|MSTR)\b/i
            );
            let name = nameMatch ? nameMatch[1].trim() : "";

            // If still no name found, try fallback (just take whatever is after 1.1)
            if (!name) {
              const fallbackName = combined.match(/\d\.\d\s+([A-Z\/\s]+)/i);
              name = fallbackName ? fallbackName[1].trim() : "";
            }

            // Clean up trailing "MR" etc accidentally stuck
            name = name.replace(/(MR|MRS|MS|MISS|MSTR)$/i, "").trim();

            let passport = "",
              country = "";
            const passSSR = line.match(/\/P\/([A-Z]{2,3})\/([A-Z0-9]+)/i);
            const passNext = nextLine.match(/^([0-9]+)/);

            if (passSSR && passNext) {
              country = passSSR[1];
              passport = passSSR[2] + passNext[1];
            } else {
              const fallback = combined.match(
                /([A-Z]{1,3}[0-9]{4,6})\/(BD|BGD)/i
              );
              if (fallback) {
                passport = fallback[1];
                country = fallback[2];
              }
            }

            if (name || passport) {
              results.push({
                Name: name,
                PNR: currentPNR,
                Passport: passport,
                Country: country,
                RBD: RBD || "",
                Need_check:
                  passport && passport.length !== 9 ? "YES" : "May be",
              });
            }
          }
        }

        downloadCSV(results);
        showErrors(results);
        resetInputs();
      }

      function resetInputs() {
        document.getElementById("fileInput").value = "";
        document.getElementById("textInput").value = "";
      }

      function showErrors(rows) {
        const old = document.getElementById("errorTable");
        if (old) old.remove();

        const errors = rows.filter((r) => r.Need_check === "YES");
        if (!errors.length) return;

        const table = document.createElement("table");
        table.id = "errorTable";
        table.style.width = "100%";
        table.style.marginTop = "20px";
        table.border = "1";

        table.innerHTML = `
          <thead>
            <tr>
              <th>Name</th><th>PNR</th><th>Passport</th><th>Country</th><th>RBD</th>
            </tr>
          </thead>
          <tbody>
            ${errors
              .map(
                (e) => `
              <tr>
                <td>${e.Name}</td>
                <td>${e.PNR}</td>
                <td>${e.Passport}</td>
                <td>${e.Country}</td>
                <td>${e.RBD}</td>
              </tr>`
              )
              .join("")}
          </tbody>
        `;

        document.querySelector(".card").appendChild(table);
        const header = "Name,PNR,Passport,Country,RBD,Need_check\n";
        const csv = errors
          .map(
            (r) =>
              `"${r.Name}","${r.PNR}","${r.Passport}","${r.Country}","${r.RBD}","${r.Need_check}"`
          )
          .join("\n");
        const blob = new Blob([header + csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "error_pnrs.csv";
        a.click();
        URL.revokeObjectURL(url);
      }

      function downloadCSV(rows) {
        const header = "Name,PNR,Passport,Country,RBD,Need_check\n";
        const csv = rows
          .map(
            (r) =>
              `"${r.Name}","${r.PNR}","${r.Passport}","${r.Country}","${r.RBD}","${r.Need_check}"`
          )
          .join("\n");
        const blob = new Blob([header + csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "pricing_hub.csv";
        a.click();
        URL.revokeObjectURL(url);
      }
    
    </script> -->
  </body>
</html>
